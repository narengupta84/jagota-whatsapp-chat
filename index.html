<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>Jagota WhatsApp</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2325D366' d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.525 3.585'/></svg>" type="image/svg+xml">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        :root {
            --bg: #0b141a;
            --panel: #111b21;
            --sidebar: #111b21;
            --header: #202c33;
            --border: #22323b;
            --search-bg: #202c33;

            --text: #e9edef;
            --muted: #93a4ad;
            --text-secondary: #667781;

            --in: #202c33;
            --out: #005c4b;
            --out-hover: #006b5a;

            --accent: #00a884;
            --accent-hover: #00927a;
            --online: #00d448;
            --sidebar-hover: #182028;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            height: 100dvh;
            background: var(--bg);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            color: var(--text);
            display: grid;
            place-items: center;
            padding: max(10px, env(safe-area-inset-top)) 10px max(10px, env(safe-area-inset-bottom));
        }

        /* WhatsApp Web container */
        .shell {
            width: min(1400px, 100%);
            height: min(850px, 100dvh);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0;
            overflow: hidden;
            display: flex;
            box-shadow: 0 16px 40px rgba(0, 0, 0, .45);
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px 16px;
            background: var(--header);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .sidebar-icons {
            display: flex;
            gap: 16px;
            color: var(--muted);
        }

        .icon {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .icon:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .search-bar {
            padding: 8px 12px;
            background: var(--search-bg);
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 14px;
        }

        .search-input::placeholder {
            color: var(--muted);
        }

        .contacts {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .contact-item:hover {
            background: var(--sidebar-hover);
        }

        .contact-item.active {
            background: var(--sidebar-hover);
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-size: 16px;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-last-message {
            font-size: 14px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .contact-time {
            font-size: 12px;
            color: var(--muted);
        }

        .unread-count {
            background: var(--accent);
            color: #111b21;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        /* Chat panel */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            position: relative;
            overflow: hidden;
        }

        /* Chat Header */
        .topbar {
            padding: 10px 16px;
            background: var(--header);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            height: 60px;
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            cursor: pointer;
        }

        .who {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .name {
            font-weight: 400;
            font-size: 16px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sub {
            color: var(--muted);
            font-size: 13px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .online-status {
            color: var(--online);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--online);
            border-radius: 50%;
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            color: var(--muted);
            position: relative;
        }

        .menu-dropdown {
            position: relative;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 140px;
            margin-top: 8px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .menu-item {
            padding: 12px 16px;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.15s;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn {
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .03);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 650;
            font-size: 12px;
        }

        .btn.primary {
            border: none;
            background: var(--accent);
            color: #062a24;
        }

        /* Chat body with plain background */
        .body {
            flex: 1;
            overflow: auto;
            padding: 14px 12px;
            background: var(--bg);
        }

        /* Day separator (optional) */
        .day {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            color: var(--muted);
            font-size: 12px;
        }

        .day span {
            background: rgba(17, 27, 33, .75);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 999px;
            backdrop-filter: blur(6px);
        }

        /* Rows and bubbles */
        .row {
            display: flex;
            margin: 2px 0;
        }

        .row.left {
            justify-content: flex-start;
        }

        .row.right {
            justify-content: flex-end;
        }

        .bubble {
            position: relative;
            max-width: min(720px, 65%);
            padding: 6px 4px 6px 6px;
            border-radius: 7px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, .13);
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.3;
            font-size: 14px;
            margin-bottom: 2px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 50%;
        }

        .bubble.in {
            background: var(--in);
            color: #e9edef;
        }

        .bubble.out {
            background: var(--out);
            color: #e9edef;
        }

        .bubble-content {
            padding-bottom: 10px;
        }

        .message-time {
            position: absolute;
            bottom: 2px;
            right: 6px;
            font-size: 11px;
            color: rgba(241, 241, 242, 0.63);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .message-status {
            display: flex;
            align-items: center;
        }

        /* Small system tag (only for SYSTEM messages) */
        .sys-tag {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            font-size: 10px;
            color: rgba(255, 255, 255, .75);
            margin-bottom: 4px;
        }

        .sys-tag .pill {
            /* No styling - just plain text */
        }

        .sys-tag .tag-right {
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, .18);
            background: rgba(255, 255, 255, .06);
            padding: 1px 4px;
            border-radius: 999px;
            font-size: 9px;
        }

        /* Contact Profile Panel */
        .contact-profile {
            position: absolute;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: var(--panel);
            border-left: 1px solid var(--border);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .contact-profile.show {
            right: 0;
        }

        .profile-header {
            background: var(--header);
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .profile-close {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: var(--muted);
            font-size: 18px;
            transition: background 0.2s;
        }

        .profile-close:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
        }

        .profile-status {
            font-size: 14px;
            color: var(--muted);
        }

        .profile-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .profile-section {
            margin-bottom: 32px;
        }

        .profile-section-title {
            font-size: 14px;
            color: var(--accent);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .profile-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 20px;
        }

        .profile-item-label {
            font-size: 13px;
            color: var(--muted);
        }

        .profile-item-value {
            font-size: 16px;
            color: var(--text);
            word-break: break-all;
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: absolute;
            top: 10px;
            right: 16px;
            z-index: 1001;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 18px;
            backdrop-filter: blur(10px);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mobile-nav:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .hamburger {
            width: 18px;
            height: 12px;
            position: relative;
            transform: rotate(0deg);
            transition: .3s ease-in-out;
        }

        .hamburger span {
            display: block;
            position: absolute;
            height: 2px;
            width: 100%;
            background: var(--text);
            border-radius: 1px;
            opacity: 1;
            left: 0;
            transform: rotate(0deg);
            transition: .2s ease-in-out;
        }

        .hamburger span:nth-child(1) {
            top: 0px;
        }

        .hamburger span:nth-child(2) {
            top: 5px;
        }

        .hamburger span:nth-child(3) {
            top: 10px;
        }

        .mobile-back {
            display: none;
            position: absolute;
            top: 10px;
            left: 16px;
            z-index: 1001;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 18px;
            backdrop-filter: blur(10px);
        }

        .mobile-back:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Composer */
        .composer {
            padding: 10px;
            border-top: 1px solid var(--border);
            background: rgba(17, 27, 33, .9);
            backdrop-filter: blur(8px);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input {
            flex: 1;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 10px 12px;
        }

        .input input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text);
            font-size: 14px;
        }

        /* Mobile tweaks */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .shell {
                width: 100%;
                height: 100dvh;
                border-radius: 0;
                border: none;
            }

            .sidebar {
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                z-index: 999;
                transition: left 0.3s ease;
            }

            .sidebar.show {
                left: 0;
            }

            .chat-panel {
                flex: 1;
                width: 100%;
            }

            .mobile-nav {
                display: block;
            }

            .mobile-back {
                display: none;
            }

            .topbar {
                padding: 10px 50px 10px 16px;
            }

            .contact-header {
                padding-left: 0;
            }

            .bubble {
                max-width: 85%;
            }

            .composer {
                display: flex !important;
                padding: 12px 16px;
            }

            /* Mobile Profile Panel - Full Screen */
            .contact-profile {
                width: 100%;
                right: -100%;
            }

            .contact-profile.show {
                right: 0;
            }

            .profile-header {
                padding: 60px 20px 20px 20px;
                position: relative;
            }

            .mobile-back.show {
                display: block;
            }

            /* Improve touch targets */
            .contact-item {
                padding: 16px;
                min-height: 72px;
            }

            .icon {
                padding: 12px;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn {
                padding: 12px 16px;
                min-height: 44px;
            }

            .search-input {
                padding: 12px 16px;
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .input input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px 0;
            }

            /* Avatar sizes */
            .avatar {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            .contact-header .avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (max-width: 520px) {
            .bubble {
                max-width: 90%;
            }

            .contact-header .avatar {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .topbar {
                padding: 8px 44px 8px 12px;
            }

            .name {
                font-size: 15px;
            }

            .sub {
                font-size: 12px;
            }

            .profile-item-value {
                font-size: 15px;
            }

            .contact-name {
                font-size: 15px;
            }

            .contact-last-message {
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div class="shell">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-profile">
                    <div class="avatar">JB</div>
                </div>
                <div class="sidebar-icons">
                    <div class="icon">‚≠Æ</div>
                    <div class="icon">üí¨</div>
                    <div class="icon">‚ãÆ</div>
                </div>
            </div>

            <div class="search-bar">
                <input class="search-input" id="searchInput" placeholder="Search or start new chat" />
            </div>

            <div class="contacts" id="contactsList">
                <!-- Contacts will be loaded dynamically -->
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <!-- Mobile Navigation -->
            <div class="mobile-nav" id="mobileNav">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="mobile-back" id="mobileBack">‚Üê</div>
            
            <div class="topbar">
                <div class="contact-header">
                    <div class="avatar" id="headerAvatar"></div>
                    <div class="who">
                        <div class="name" id="custName"></div>
                        <div class="sub">
                            <span id="lastSeenText"></span>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <div class="icon" title="Search">üîç</div>
                    <div class="icon" id="btnRefresh" title="Refresh">‚≠Æ</div>
                    <div class="menu-dropdown">
                        <div class="icon" id="menuBtn" title="Menu">‚ãÆ</div>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <div class="menu-item" onclick="showProfile()">Profile</div>
                            <div class="menu-item" onclick="showSettings()">Settings</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="body" id="chatBody"></div>

            <!--<div class="composer" style="display:none;">
                <div class="input">
                    <input id="msgInput" type="text" placeholder="Type a message" />
                </div>
                <button class="btn primary" id="sendBtn">‚û§</button>
            </div>-->

            <!-- Contact Profile Panel -->
            <div class="contact-profile" id="contactProfile">
                <div class="profile-header">
                    <div class="profile-close" id="profileClose">‚úï</div>
                    <div class="profile-avatar" id="profileAvatar"></div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-status" id="profileStatus"></div>
                    </div>
                </div>
                <div class="profile-body">
                    <div class="profile-section">
                        <div class="profile-section-title">Contact Info</div>
                        <div class="profile-item">
                            <div class="profile-item-label">Name</div>
                            <div class="profile-item-value" id="profileContactName"></div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-item-label">Phone</div>
                            <div class="profile-item-value" id="profilePhone"></div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-item-label">Supplier Code</div>
                            <div class="profile-item-value" id="profileSupCode"></div>
                        </div>
                        <div class="profile-item">
                            <div class="profile-item-label">Last Seen</div>
                            <div class="profile-item-value" id="profileLastSeen"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== DROPDOWN FUNCTIONALITY =====
        $(document).ready(function () {
            $('#menuBtn').on('click', function (e) {
                e.stopPropagation();
                $('#dropdownMenu').toggleClass('show');
                console.log('Menu clicked, dropdown toggled');
            });

            // Prevent dropdown from closing when clicking inside
            $('#dropdownMenu').on('click', function (e) {
                e.stopPropagation();
            });
        });

        function showProfile() {
            $('#dropdownMenu').removeClass('show');
        }

        function showSettings() {
            $('#dropdownMenu').removeClass('show');
            alert('Settings functionality coming soon!');
        }

        // ===== CONFIG =====
        const BASE_URL = "https://jnodeapi.jagota.com";
        const BEARER_TOKEN = "ZKp9XWQ4h7A2mE8sF0YcD6LJ5BfR3Vn1CqH9tUeMKa0dP4iG8oS2x";

        // Extract phone number from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        let TO_NUMBER = '+' + (urlParams.get('mobile') || '');

        let CUSTOMER_NAME = ""; // Will be set dynamically from API response
        let CONTACTS_DATA = []; // Will store contacts from API
        let SELECTED_CONTACT = null; // Currently selected contact

        const POST_OUTBOUND_URL = `${BASE_URL}/v1/whatsapp/outbound`;
        const GET_CONTACTS_URL = `${BASE_URL}/v1/whatsapp/contacts`; // New contacts API
        let GET_MESSAGES_URL = `${BASE_URL}/v1/whatsapp/chat?mobile=${TO_NUMBER}`;


        // ===== HELPERS =====
        $("#profileBtn").on("click", function () {
            $("#dropdownMenu").removeClass("show");
            $("#profileModal").addClass("show");
        });

        // Close profile modal
        $("#closeModal").on("click", function () {
            $("#profileModal").removeClass("show");
        });

        // Close modal when clicking outside
        $("#profileModal").on("click", function (e) {
            if (e.target === this) {
                $(this).removeClass("show");
            }
        });

        // Settings button (placeholder)
        $("#settingBtn").on("click", function () {
            $("#dropdownMenu").removeClass("show");
            alert("Settings functionality coming soon!");
        });

        // ===== EXISTING FUNCTIONALITY =====
        function esc(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        // You asked: based on inbound/outbound change direction.
        // - inbound => left
        // - outbound/template => right
        function getSide(m) {
            return (String(m.messageDirection || "").toLowerCase() === "inbound") ? "left" : "right";
        }
        function getBubbleClass(m) {
            return (String(m.messageDirection || "").toLowerCase() === "inbound") ? "in" : "out";
        }

        // Show system tags with direction on left, SYSTEM always on right
        function systemTag(m) {
            const by = String(m.createdBy || "").toUpperCase();
            if (by !== "SYSTEM") return "";
            const direction = m.direction || m.messageDirection || "SYSTEM";

            return `<div class="sys-tag"><span class="pill">${esc(direction)}</span><span class="tag-right">SYSTEM</span></div>`;
        }

        // Function to get message status display
        function getMessageStatus(m) {
            const direction = String(m.messageDirection || "").toLowerCase();
            
            if (direction === "inbound") {
                // For inbound messages, check smsStatus
                if (m.smsStatus === "received") {
                    return `<span class="message-status" title="${esc(m.smsStatus)}">‚úì‚úì</span>`;
                } else if (m.smsStatus) {
                    return `<span class="message-status" title="${esc(m.smsStatus)}">‚úì</span>`;
                }
                return '';
            } else {
                // For outbound messages, check status
                if (m.status === "delivered") {
                    return `<span class="message-status" title="${esc(m.status)}">‚úì‚úì</span>`;
                } else if (m.status === "sent") {
                    return `<span class="message-status" title="${esc(m.status)}">‚úì</span>`;
                } else if (m.status) {
                    return `<span class="message-status" title="${esc(m.status)}">‚úì</span>`;
                }
                return '';
            }
        }

        function render(rows) {
            const $body = $("#chatBody").empty();
            let lastDay = null;

            rows.forEach(m => {
                // Extract just the date part from the timestamp
                const fullDate = m.createdOn || "";
                const day = fullDate.split(' ')[0] || ""; // Gets "26-Jan-2026" from "26-Jan-2026 05:12:18 PM"
                if (day && day !== lastDay) {
                    $body.append(`<div class="day"><span>${esc(day)}</span></div>`);
                    lastDay = day;
                }

                const side = getSide(m);
                const bubbleCls = getBubbleClass(m);
                
                // Extract and format time from createdOn
                let messageTime = ""; // fallback
                if (m.createdOn) {
                    const timeFormatted = m.createdOn.split(' ').slice(1, 3).join(' ').replace(/(\d{2}):(\d{2}):(\d{2})/, '$1:$2');
                    if (timeFormatted) {
                        messageTime = timeFormatted;
                    }
                }

                $body.append(`
        <div class="row ${side}">
          <div class="bubble ${bubbleCls}">
            ${systemTag(m)}
            <div class="bubble-content">${esc(m.body)}</div>
            <div class="message-time">
              <span>${esc(messageTime)}</span>
              ${getMessageStatus(m)}
            </div>
          </div>
        </div>
      `);
            });

            // Update message count in sidebar
            //$(".unread-count").text(rows.length);
            $body.scrollTop($body[0].scrollHeight);
        }

        function loadContacts() {
            $.ajax({
                url: GET_CONTACTS_URL,
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${BEARER_TOKEN}`
                },
                dataType: "json",
                success: function (resp) {
                    const contacts = resp.data || [];
                    CONTACTS_DATA = contacts;
                    renderContacts(contacts);
                    
                    // If no contact is selected and we have contacts, select the first one
                    if (!SELECTED_CONTACT && contacts.length > 0) {
                        selectContact(contacts[0]);
                    }
                },
                error: function () {
                    console.error("Failed to load contacts");
                }
            });
        }

        function renderContacts(contacts) {
            const $contactsList = $("#contactsList").empty();
            
            if (contacts.length === 0) {
                $contactsList.append('<div style="padding: 20px; text-align: center; color: var(--muted); font-size: 14px;">No contacts found</div>');
                return;
            }
            
            contacts.forEach(contact => {
                const firstLetter = contact.contact.charAt(0).toUpperCase();
                const isActive = SELECTED_CONTACT && SELECTED_CONTACT.mobile === contact.mobile ? 'active' : '';
                
                const $contactItem = $(`
                    <div class="contact-item ${isActive}" data-mobile="${contact.mobile}" data-contact='${JSON.stringify(contact)}'>
                        <div class="avatar">${firstLetter}</div>
                        <div class="contact-info">
                            <div class="contact-name">${esc(contact.contact)}</div>
                            <div class="contact-last-message">Sup code: ${esc(contact.supCode)}</div>
                        </div>
                        <div class="contact-meta">
                            <div class="contact-time"></div>
                            <div class="unread-count">${esc(contact.msgCount)}</div>
                        </div>
                    </div>
                `);
                
                $contactItem.on('click', function() {
                    const contactData = JSON.parse($(this).attr('data-contact'));
                    selectContact(contactData);
                });
                
                $contactsList.append($contactItem);
            });
        }

        function selectContact(contact) {
            SELECTED_CONTACT = contact;
            TO_NUMBER = '+' + contact.mobile;
            CUSTOMER_NAME = contact.contact;
            GET_MESSAGES_URL = `${BASE_URL}/v1/whatsapp/chat?mobile=${TO_NUMBER}`;
            
            // Update active contact in sidebar
            $('.contact-item').removeClass('active');
            $(`.contact-item[data-mobile="${contact.mobile}"]`).addClass('active');
            
            // Update header with selected contact info
            const firstLetter = contact.contact.charAt(0).toUpperCase();
            $("#headerAvatar").text(firstLetter);
            $("#custName").text(contact.contact);
            
            // Update URL parameter
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('mobile', contact.mobile);
            window.history.pushState({ path: newUrl.href }, '', newUrl.href);
            
            // Hide sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                hideSidebar();
            }
            
            // Update mobile navigation
            updateMobileNavigation();
            
            // Load messages for selected contact
            loadMessages();
        }

        function loadMessages() {
            if (!TO_NUMBER || TO_NUMBER === '+') {
                $("#chatBody").empty().append('<div style="text-align: center; padding: 50px; color: var(--muted);">Select a contact to view messages</div>');
                return;
            }
            
            $.ajax({
                url: GET_MESSAGES_URL,
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${BEARER_TOKEN}`
                },
                dataType: "json",
                success: function (resp) {
                    const rows = resp.data || resp.result || resp || [];
                    
                    // Extract customer name from first non-null profileName
                    if (!CUSTOMER_NAME && rows.length > 0) {
                        for (const message of rows) {
                            if (message.profileName && message.profileName.trim()) {
                                CUSTOMER_NAME = message.profileName.trim();
                                // Update UI with the customer name
                                $("#custName").text(CUSTOMER_NAME);
                                $("#sidebarContactName").text(CUSTOMER_NAME);
                                
                                // Update avatars with first letter of customer name
                                const firstLetter = CUSTOMER_NAME.charAt(0).toUpperCase();
                                $("#contactAvatar").text(firstLetter);
                                $("#headerAvatar").text(firstLetter);
                                break;
                            }
                        }
                    }
                    
                    // Update sidebar contact time from most recent message
                    if (rows.length > 0 && SELECTED_CONTACT) {
                        const mostRecentMessage = rows[rows.length - 1];
                        if (mostRecentMessage.createdOn) {
                            const timeFormatted = mostRecentMessage.createdOn.split(' ').slice(1, 3).join(' ').replace(/(\d{2}):(\d{2}):(\d{2})/, '$1:$2');
                            if (timeFormatted) {
                                $(`.contact-item[data-mobile="${SELECTED_CONTACT.mobile}"] .contact-time`).text(timeFormatted);
                            }
                        }
                        
                        // Update message count in sidebar for selected contact
                        //$(`.contact-item[data-mobile="${SELECTED_CONTACT.mobile}"] .unread-count`).text(rows.length).show();
                    }
                    
                    // Extract last seen time from most recent inbound message
                    if (rows.length > 0) {
                        // Find the most recent inbound message
                        const inboundMessages = rows.filter(m => 
                            String(m.messageDirection || "").toLowerCase() === "inbound" && m.createdOn
                        );
                        
                        if (inboundMessages.length > 0) {
                            // Get the most recent inbound message (assuming array is sorted by time)
                            const lastInboundMessage = inboundMessages[inboundMessages.length - 1];
                            const createdOn = lastInboundMessage.createdOn || "";
                            
                            // Parse the full date "26-Jan-2026 05:12:18 PM"
                            if (createdOn) {
                                const [datePart, timePart] = createdOn.split(' ', 2);
                                const timeFormatted = createdOn.split(' ').slice(1, 3).join(' ').replace(/(\d{2}):(\d{2}):(\d{2})/, '$1:$2');
                                
                                // Parse the date to compare with today
                                const messageDate = new Date(datePart.replace(/-/g, ' '));
                                const today = new Date();
                                today.setHours(0, 0, 0, 0); // Reset time for date comparison
                                messageDate.setHours(0, 0, 0, 0);
                                
                                const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
                                
                                let dayText;
                                if (diffDays === 0) {
                                    dayText = "today";
                                } else if (diffDays === 1) {
                                    dayText = "yesterday";
                                } else if (diffDays === -1) {
                                    dayText = "tomorrow";
                                } else {
                                    // Show the actual date for other days
                                    dayText = `on ${datePart}`;
                                }
                                
                                $("#lastSeenText").text(`Last seen ${dayText} at ${timeFormatted}`);
                            }
                        }
                    }
                    
                    render(rows);
                },
                error: function () {
                    alert("Failed to load messages");
                }
            });
        }

        function sendMessage(text) {
            return $.ajax({
                url: POST_OUTBOUND_URL,
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${BEARER_TOKEN}`
                },
                contentType: "application/json",
                data: JSON.stringify({ to: TO_NUMBER, body: text })
            });
        }

        // ===== MOBILE FUNCTIONALITY =====
        function showSidebar() {
            $('.sidebar').addClass('show');
        }
        
        function hideSidebar() {
            $('.sidebar').removeClass('show');
        }
        
        function updateMobileNavigation() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Show/hide appropriate navigation buttons
                if ($('#contactProfile').hasClass('show')) {
                    $('#mobileNav').hide();
                    $('#mobileBack').addClass('show');
                } else {
                    $('#mobileNav').show();
                    $('#mobileBack').removeClass('show');
                }
                
                // Show composer when contact is selected
                if (SELECTED_CONTACT) {
                    $('.composer').hide();
                } else {
                    $('.composer').hide();
                }
            } else {
                $('#mobileNav').hide();
                $('#mobileBack').removeClass('show');
                $('.composer').toggle(!!SELECTED_CONTACT);
                $('.composer').hide();
            }
        }

        // ===== CONTACT PROFILE FUNCTIONALITY =====
        function showContactProfile() {
            if (!SELECTED_CONTACT) return;
            
            // Populate profile panel with contact information
            const firstLetter = SELECTED_CONTACT.contact.charAt(0).toUpperCase();
            $("#profileAvatar").text(firstLetter);
            $("#profileName").text(SELECTED_CONTACT.contact);
            $("#profileContactName").text(SELECTED_CONTACT.contact);
            $("#profilePhone").text('+' + SELECTED_CONTACT.mobile);
            $("#profileSupCode").text(SELECTED_CONTACT.supCode || 'N/A');
            
            // Get last seen from the current display
            const lastSeenText = $("#lastSeenText").text() || 'Unknown';
            $("#profileLastSeen").text(lastSeenText);
            $("#profileStatus").text(lastSeenText);
            
            // Show profile panel
            $("#contactProfile").addClass('show');
            
            // Update mobile navigation
            updateMobileNavigation();
        }
        
        function hideContactProfile() {
            $("#contactProfile").removeClass('show');
            updateMobileNavigation();
        }

        // ===== SEARCH FUNCTIONALITY =====
        function searchContacts(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                // Show all contacts if search is empty
                renderContacts(CONTACTS_DATA);
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            const filteredContacts = CONTACTS_DATA.filter(contact => {
                const name = (contact.contact || '').toLowerCase();
                const supCode = (contact.supCode || '').toLowerCase();
                return name.includes(term) || supCode.includes(term);
            });
            
            renderContacts(filteredContacts);
        }

        // ===== EVENTS =====
        $("#searchInput").on("input keyup", function() {
            const searchTerm = $(this).val();
            searchContacts(searchTerm);
        });

        // Mobile navigation
        $("#mobileNav").on("click", function() {
            showSidebar();
        });
        
        $("#mobileBack").on("click", function() {
            hideContactProfile();
        });

        // Contact header click to show profile
        $(document).on('click', '.contact-header', function() {
            showContactProfile();
        });
        
        // Profile close button
        $("#profileClose").on("click", function() {
            hideContactProfile();
        });
        
        // Close profile when clicking outside
        $(document).on("click", function(e) {
            // Check if click is outside the contact profile panel and not on the contact header
            if (!$(e.target).closest('#contactProfile, .contact-header').length) {
                hideContactProfile();
            }
            
            // Also close dropdown menu when clicking outside
            if (!$(e.target).closest('#dropdownMenu, #menuBtn').length) {
                $("#dropdownMenu").removeClass("show");
            }
            
            // Close sidebar on mobile when clicking outside
            if (window.innerWidth <= 768 && !$(e.target).closest('.sidebar, #mobileNav').length) {
                hideSidebar();
            }
        });
        
        // Prevent profile panel from closing when clicking inside it
        $("#contactProfile").on("click", function(e) {
            e.stopPropagation();
        });
        
        // Prevent sidebar from closing when clicking inside it
        $(".sidebar").on("click", function(e) {
            e.stopPropagation();
        });
        
        // Close profile with Escape key
        $(document).on("keydown", function (e) {
            if (e.key === "Escape") {
                $("#dropdownMenu").removeClass("show");
                hideContactProfile();
                if (window.innerWidth <= 768) {
                    hideSidebar();
                }
            }
        });
        
        // Handle window resize
        $(window).on('resize', function() {
            updateMobileNavigation();
            
            if (window.innerWidth > 768) {
                // Desktop mode - ensure sidebar is visible and positioned correctly
                $('.sidebar').removeClass('show').css('left', '');
            }
        });

        $("#btnRefresh").on("click", function() {
            loadContacts();
            loadMessages();
            // Clear search when refreshing
            $("#searchInput").val('');
        });

        $("#sendBtn").on("click", function () {
            const text = $("#msgInput").val().trim();
            if (!text) return;
            sendMessage(text).done(function () {
                $("#msgInput").val("");
                // Reload messages from API after successful send
                loadMessages();
            }).fail(function () {
                alert("Failed to send message");
            });
        });

        $("#msgInput").on("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                $("#sendBtn").click();
            }
        });

        // Note: Escape key handler moved up with profile functionality

        // ===== INIT =====
        $(function () {
            // Load contacts first
            loadContacts();
            
            // If mobile parameter exists in URL, try to select that contact
            const urlMobile = urlParams.get('mobile');
            if (urlMobile) {
                // Wait a bit for contacts to load, then try to select
                setTimeout(() => {
                    const contact = CONTACTS_DATA.find(c => c.mobile === urlMobile);
                    if (contact) {
                        selectContact(contact);
                    }
                }, 500);
            }
            
            // Initialize mobile navigation
            updateMobileNavigation();
            
            // Auto-refresh messages every 5 seconds (reduced frequency)
            setInterval(() => {
                if (SELECTED_CONTACT) {
                    loadMessages();
                }
            }, 5000);
        });
    </script>
</body>

</html>
